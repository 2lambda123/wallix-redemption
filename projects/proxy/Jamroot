#import gcc ;
import os ;

# below feature rule come from http://www.boost.org/doc/tools/build/doc/html/bbv2/extending/features.html

import feature : feature ;
import modules : poke ;

# this feature is defined so we can add a dependency on <distri>lenny for some targets
# disabled because in our current code it finds the right library
#feature distri : none lenny : propagated ;

# No need to make it a new variant after all
#variant lenny : release ;

path-constant TOP : . ;
constant SRCDIR : ../../src ;
constant INCLUDEDIR : ../../include ;
constant TESTDIR : ../../tests ;
constant MODULEDIR : ../../modules ;


# Returns environment value if it exists or default otherwise.
# Allow us to customize install path with shell variables like $PREFIX...
# (this is bad practice and should be replaced by a site configuration file
# but I until now I miserably failed creating a clean separate configuration file)
rule setvar ( env : default * )
{
    if [ os.environ $(env) ]
    {
        return [ os.environ $(env) ] ;
    }
    else
    {
        return $(default) ;
    }
}

constant ARCH : [ SHELL "lscpu | perl -ne 'if (/^Architecture.*(x86_64|i386|i686)/) {print $1};'" ] ;
# constant ARCH : [ SHELL "lscpu | perl -ane 'my %h = map { $F[0], $F[1] } <>; print $h{q{Architecture:}}'" ] ;
constant PYTHON_VER : [ SHELL "perl -e 'for my $x (q{python2.7}, q{python2.6}) { if (-e q{/usr/include/}.$x.q{/Python.h}){ print $x; last;}};'" ] ;
constant PYTHON_INCLUDE : [ SHELL "perl -e 'for my $x (q{python2.7}, q{python2.6}) { if (-e q{/usr/include/}.$x.q{/Python.h}){ print q{/usr/include/}.$x; last;}};'" ] ;


constant FIXTURES_PATH : [ setvar FIXTURES_PATH : $(TESTDIR)/fixtures ] ;
constant INSTALLDIR : [ setvar DESTDIR : "" ] ;
constant PREFIX : [ setvar PREFIX : /usr/local ] ;
constant BIN_PREFIX : [ setvar BIN_PREFIX : $(PREFIX)/bin ] ;
constant LIB_PREFIX : [ setvar LIB_PREFIX : $(PREFIX)/lib ] ;
constant SHARE_PREFIX : [ setvar SHARE_PREFIX : $(PREFIX)/share/rdpproxy ] ;
constant RECORD_TMP_PATH : [ setvar RECORD_TMP_PATH : /var/rdpproxy/tmp ] ;
constant RECORD_PATH : [ setvar RECORD_PATH : /var/rdpproxy/recorded ] ;
constant ETC_PREFIX : [ setvar ETC_PREFIX : /etc/rdpproxy ] ;
constant CERT_PREFIX : [ setvar CERT_PREFIX : /etc/rdpproxy/cert ] ;
constant HASH_PATH : [ setvar HASH_PATH : /var/rdpproxy/hash ] ;
constant PERSISTENT_PATH : [ setvar PERSISTENT_PATH : /var/lib/redemption/cache ] ;
constant DRIVE_REDIRECTION_PATH : [ setvar DRIVE_REDIRECTION_PATH : /var/rdpproxy/drive_redirection ] ;

constant COVERAGE_PREFIX : [ setvar COVERAGE_PREFIX : "" ] ;

constant PNG_DEBUG : <variant>debug:<library>png ;

rule defines ( properties * )
{
    local defs ;
    defs += <define>SHARE_PATH='\"$(PREFIX)/share/rdpproxy\"' ;
    defs += <define>CFG_PATH='\"$(ETC_PREFIX)\"' ;
    defs += <define>RECORD_PATH='\"$(RECORD_PATH)\"' ;
    defs += <define>RECORD_TMP_PATH='\"$(RECORD_TMP_PATH)\"' ;
    defs += <define>FLV_PATH='\"$(RECORD_TMP_PATH)\"' ;
    defs += <define>OCR_PATH='\"$(RECORD_TMP_PATH)\"' ;
    defs += <define>PNG_PATH='\"$(RECORD_TMP_PATH)\"' ;
    defs += <define>WRM_PATH='\"$(RECORD_PATH)\"' ;
    defs += <define>HASH_PATH='\"$(HASH_PATH)\"' ;
    defs += <define>LICENSE_PATH='\"$(CERT_PREFIX)/rdplicense\"' ;
    defs += <define>CERTIF_PATH='\"$(CERT_PREFIX)/rdp\"' ;
    defs += <define>FIXTURES_PATH='\"$(FIXTURES_PATH)\"' ;
    defs += <define>PERSISTENT_PATH='\"$(PERSISTENT_PATH)\"' ;
    defs += <define>DRIVE_REDIRECTION_PATH='\"$(DRIVE_REDIRECTION_PATH)\"' ;
    if [ os.environ VERBOSE ]
    {
        defs += <define>VERBOSE ;
    }
    return $(defs) ;
}
variant coverage : debug : <cxxflags>--profile-arcs <cxxflags>--test-coverage <cxxflags>--coverage <link>shared ;


constant CXXFLAGS-COMMON :
#     <cxxflags>-Weffc++
#     <cxxflags>-Wswitch-enum
#     <cxxflags>-Wswitch-default
    <cxxflags>-pedantic
    <cxxflags>-pedantic-errors
#    <cxxflags>-Wconversion
    <cxxflags>-Wvla
    <cxxflags>-Wstrict-aliasing=2
#    <cxxflags>-Wlong-long

    <cxxflags>-Wuninitialized
    <cxxflags>-Wnon-virtual-dtor
    <cxxflags>-Wall
    <cxxflags>-Wextra
    <cxxflags>-Wno-unused-parameter
    <cxxflags>-Wno-long-long
    <cxxflags>-Wtype-limits
    <cxxflags>-Wundef
    <cxxflags>-Wcast-align
    <cxxflags>-Wchar-subscripts
#     <cxxflags>-Wformat
    <cxxflags>-Wformat=2
    <cxxflags>-Wformat-security
#     <cxxflags>-Wmissing-format-attribute
    <cxxflags>-Wsequence-point
    <cxxflags>-Wreturn-type
    <cxxflags>-Wfloat-equal
#     <cxxflags>-Wshadow
    <cxxflags>-Wpointer-arith
    <cxxflags>-Wsign-compare
#     <cxxflags>-Wmissing-declarations
    <cxxflags>-Wpacked
    <cxxflags>-Wredundant-decls
#     <cxxflags>-Winline
    <cxxflags>-Winit-self
    <cxxflags>-Wcast-qual
    <cxxflags>-Woverloaded-virtual
    <cxxflags>-Wunused-variable
#     <cxxflags>-Wunused-parameter
    <cxxflags>-Wmissing-include-dirs
    <cxxflags>-Wunused
    <cxxflags>-Wendif-labels
    <cxxflags>-Wwrite-strings
#     <cxxflags>-Wpadded
    <cxxflags>-Wstrict-overflow=1
#     <cxxflags>-Wstrict-overflow=5
    <cxxflags>-Wc++11-compat
    <cxxflags>-Wnarrowing
    <cxxflags>-Wvolatile-register-var
    <cxxflags>-Wdisabled-optimization
    <cxxflags>-Wno-overlength-strings
    <cxxflags>-Warray-bounds
    <cxxflags>-Wold-style-cast

#     <toolset>clang:<cxxflags>-Weverything
#     <toolset>clang:<cxxflags>-Wno-c++98-compat
    <toolset>clang:<cxxflags>-Wno-mismatched-tags
#    <toolset>clang:<cxxflags>-Wno-overloaded-virtual
    <toolset>clang:<cxxflags>-Wno-char-subscripts
    <toolset>clang:<cxxflags>-Wno-unused-variable
#     <toolset>clang:<cxxflags>-Wno-unused-private-field
;


constant CXXFLAGS-GCC-4.7 :
    <cxxflags>-Wunused-but-set-parameter
    <cxxflags>-Wunused-but-set-variable
#     <cxxflags>-Wsuggest-attribute=pure
#     <cxxflags>-Wsuggest-attribute=const
    <cxxflags>-Wsuggest-attribute=noreturn
    <cxxflags>-Wzero-as-null-pointer-constant
    <cxxflags>-Wlogical-op
#     <cxxflags>-Wno-aggressive-loop-optimizations
    <cxxflags>-Wnormalized=nfc #disable ?
    <cxxflags>-Wvector-operation-performance
    <cxxflags>-Wdouble-promotion
   <cxxflags>-Wmaybe-uninitialized
    <cxxflags>-Wtrampolines
;


constant CXXFLAGS-GCC-4.8 :
    $(CXXFLAGS-GCC-4.7)
    <cxxflags>-Wuseless-cast
;


constant CXXFLAGS-GCC-4.9 :
    $(CXXFLAGS-GCC-4.8)
    <cxxflags>-Wconditionally-supported
    <cxxflags>-Wfloat-conversion
    <cxxflags>-Wopenmp-simd
    <cxxflags>-Wparentheses

    <variant>release:<cxxflags>-flto
;


constant CXXFLAGS-GCC-5 :
    $(CXXFLAGS-GCC-4.9)
    <cxxflags>-Wlogical-not-parentheses
    <cxxflags>-Wswitch-bool
    <cxxflags>-Wsizeof-array-argument
    <cxxflags>-Wbool-compare
#    <cxxflags>-Wsuggest-final-types
#    <cxxflags>-Wsuggest-final-methods
#     <cxxflags>-Wsuggest-attribute=pure
#    <cxxflags>-Wsuggest-attribute=const
    <variant>release:<cxxflags>-flto-odr-type-merging
    # <cxxflags>-Wno-odr #  Requires -flto-odr-type-merging to be enabled (enabled by ##default)
;


constant CXXFLAGS-GCC-5.1 :
    $(CXXFLAGS-GCC-5)
    <cxxflags>-Wsuggest-override
    <cxxflags>-fsized-deallocation
    <cxxflags>-Wsized-deallocation
    <cxxflags>-Warray-bounds=2
;


constant CXXFLAGS-GCC-6 :
    $(CXXFLAGS-GCC-5)
;


# switch [ modules.peek : ODSHOME ]
# {
#     case *gcc-4.8* : constant CXXFLAGS-GCC : $(CXXFLAGS-GCC-4.8) ;
#     case *gcc-4.9* : constant CXXFLAGS-GCC : $(CXXFLAGS-GCC-4.9) ;
#     case *gcc-5*   : constant CXXFLAGS-GCC : $(CXXFLAGS-GCC-5) ;
#     case *gcc-6*   : constant CXXFLAGS-GCC : $(CXXFLAGS-GCC-6) ;
# }


#gcov -a -c -b -f -o bin/gcc-4.6/coverage/tests/test_stream.gcno bin/gcc-4.6/coverage/test_stream

lib gcov : : <name>gcov : ;

constant GCOV : <variant>coverage:<library>gcov ;
constant GCOV_NO_BUILD : <variant>coverage:<build>no ;

variant strict : :
    <cxxflags>-Wsign-conversion
;

variant asan : debug :
#    <cxxflags>-fsanitize=address
#    <cxxflags>-fsanitize=leak
#    <cxxflags>-fno-omit-frame-pointer
#    <linkflags>-lasan
#    <define>CXX_ENABLE_ASAN
;
constant LIB_SAN_DEPENDENCY :
    <variant>asan:<library>libasan
    <variant>asan:<cxxflags>-fsanitize=address
#    <variant>asan:<cxxflags>-fsanitize=leak
    <variant>asan:<cxxflags>-fno-omit-frame-pointer
    <variant>asan:<define>CXX_ENABLE_ASAN
;

project redemption
    : requirements
    <include>$(SRCDIR)
    <include>$(INCLUDEDIR)
    <include>$(SRCDIR)/system/linux
    <include>$(SRCDIR)/core
    <include>$(SRCDIR)/mod
    <include>$(SRCDIR)/front
    <include>$(SRCDIR)/acl
    <include>$(SRCDIR)/capture
    <include>$(SRCDIR)/keyboard
    <include>$(SRCDIR)/keyboard/reversed_keymaps
    <include>$(SRCDIR)/regex
    <include>$(SRCDIR)/headers
    <include>$(SRCDIR)/main
    <include>$(MODULEDIR)/includes
    <include>/usr/include

    <conditional>@defines

    <variant>debug:<define>REDASSERT_AS_ASSERT
    <variant>debug:<cxxflags>-g

    <cxxflags>-std=c++11


    $(CXXFLAGS-COMMON)
    <toolset>gcc-4.7:$(CXXFLAGS-GCC-4.7)
    <toolset>gcc-4.8:$(CXXFLAGS-GCC-4.8)
    <toolset>gcc-4.9:$(CXXFLAGS-GCC-4.9)
    <toolset>gcc-4.9.1:$(CXXFLAGS-GCC-4.9)
    <toolset>gcc-4.9.2:$(CXXFLAGS-GCC-4.9)
    <toolset>gcc-4.9.3:$(CXXFLAGS-GCC-4.9)
    <toolset>gcc-5.0:$(CXXFLAGS-GCC-5)
    <toolset>gcc-5.0.0:$(CXXFLAGS-GCC-5)
    <toolset>gcc-5.1.0:$(CXXFLAGS-GCC-5.1)
    <toolset>gcc-5.1:$(CXXFLAGS-GCC-5.1)
    <toolset>gcc-5.2.0:$(CXXFLAGS-GCC-5.1)
    <toolset>gcc-5.2:$(CXXFLAGS-GCC-5.1)
    <toolset>gcc-6.0:$(CXXFLAGS-GCC-6)
    <toolset>gcc-6.1:$(CXXFLAGS-GCC-6)

#    <cxxflags>-fpie
    <cxxflags>-fPIC


    <define>_FILE_OFFSET_BITS=64
    <define>_LARGEFILE64_SOURCE

    <define>__STDC_FORMAT_MACROS

    <define>PUBLIC

   : default-build release

;

explicit install instexe install-bin install-etc install-etc-themes install-share install-lib check_coverage exe ;

alias instexe : install-bin ;
alias install : install-bin install-etc install-etc-themes install-share install-lib ;
alias exe     : rdpproxy rdptproxy rdptanalyzer rdpclient ;
alias libs    : libredver libreddec libredrec ;


install install-bin
    : exe
    : <install-type>EXE <install-dependencies>on
    : <location>$(INSTALLDIR)/usr/local/bin
    ;

install install-share
    : [ glob sys/share/rdpproxy/[^.k]* ]
    :
    : <location>$(INSTALLDIR)/usr/local/share/rdpproxy
    ;

install install-etc
    : [ glob sys/etc/rdpproxy/*ini sys/etc/rdpproxy/*pem sys/etc/rdpproxy/*crt sys/etc/rdpproxy/*key sys/etc/rdpproxy/*p12 ]
    :
    : <location>$(INSTALLDIR)/etc/rdpproxy
    ;

install install-etc-themes
    : [ glob sys/etc/rdpproxy/themes/HOWTO ]
    :
    : <location>$(INSTALLDIR)/etc/rdpproxy/themes
    ;

install install-lib
    : libs
    :
    : <location>$(INSTALLDIR)/usr/lib
    ;

actions gen_redcryptofile {
    echo "$(>)" "$(<)" ;
    cp "$(>)" "$(<)"
    cp "$(<)" tools/redcryptofile/redcryptofile.so
}

explicit pycryptofile redcryptofile.so ;

lib pycryptofile :
        tools/redcryptofile/pycrypto.cpp
    :
        <define>REDPYTHON_BINDING
        <include>$(PYTHON_INCLUDE)
        <cxxflags>-fPIC
        <cflags>-fPIC
        <link>shared
        <library>snappy
        <library>python2
        <library>crypto
    ;

make redcryptofile.so
    :
        pycryptofile
    :
        @gen_redcryptofile
    ;

lib libboost_unit_test : : <name>boost_unit_test_framework <link>shared ;
lib openssl : : <name>ssl <link>shared ;
# lib X11 : : <name>X11 <link>shared ;
# lib Xfixes : : <name>Xfixes <link>static ;
# lib pthread : : <name>pthread <link>shared ;
# lib pam : : <name>pam <link>static ;

lib krb5 : : <name>krb5 <link>shared ;
lib gssglue : : <name>gssglue <link>shared ;

lib crypto : : <name>crypto <link>shared ;
lib z : : <name>z <link>shared ;
lib snappy : : <name>snappy <link>shared ;
# lib lzma : : <name>lzma <link>shared ;
lib dl : : <name>dl <link>shared ;
lib python2 : : <name>$(PYTHON_VER) <link>shared ;


# lib lcms : : <name>lcms <link>shared ;

# lib tiff : : <name>tiff <link>static ;
# lib freetype : : <name>freetype <link>static ;
# lib jpeg : : <name>jpeg <link>static ;
# lib Xext : : <name>Xext <link>static ;

lib libpng : : <name>png <link>shared ;
alias png : libpng z ;

# lib icuuc : : <name>icuuc ;

lib libasan : libboost_unit_test openssl krb5 gssglue crypto snappy png dl python2 : <name>asan ;

obj mainloop : $(SRCDIR)/core/mainloop.cpp ;
obj d3des : $(SRCDIR)/utils/d3des.cpp ;
obj bitmap : $(SRCDIR)/utils/bitmap_data_allocator.cpp ;
obj program_options : $(MODULEDIR)/program_options/src/program_options.cpp ;

constant LIB_TEST_DEPENDENCY : <library>libboost_unit_test ;

constant EXE_DEPENDENCIES : $(LIB_SAN_DEPENDENCY) $(GCOV) ;
constant TEST_DEPENDENCIES : <include>$(TESTDIR) $(LIB_SAN_DEPENDENCY) $(LIB_TEST_DEPENDENCY) $(GCOV) ;


#
# Redemption
#

exe rdpproxy
    :
        $(SRCDIR)/main/main.cpp
        bitmap
        program_options

        mainloop

        d3des

        openssl
        crypto
        z
        dl
        png

        snappy
#        lzma

        krb5
        gssglue
    :
#         <link>static
        $(EXE_DEPENDENCIES)
    ;

lib libredrec
    :
        $(SRCDIR)/main/do_recorder.cpp
        bitmap
        program_options

        openssl
        crypto
        png
        z
        dl

        snappy
    :
        <cxxflags>-fPIC
        <cxxflags>-fvisibility=hidden
    ;

lib libreddec
    :
        $(SRCDIR)/main/do_decrypter.cpp
        program_options

        openssl
        crypto
        z
        dl

        snappy
    :
        <cxxflags>-fPIC
        <cxxflags>-fvisibility=hidden
    ;

lib libredver
    :
        $(SRCDIR)/main/do_verifier.cpp
        program_options

        openssl
        crypto
        z
        dl

        snappy
    :
        <cxxflags>-fPIC
        <cxxflags>-fvisibility=hidden
    ;

exe rdptproxy
    :
        $(SRCDIR)/main/transparent.cpp
        bitmap
        program_options

        openssl
        crypto
        png
        z
        dl

        snappy
#        lzma

        krb5
        gssglue
    :
#         <link>static
        $(EXE_DEPENDENCIES)
    ;

exe rdptanalyzer
    :
        $(SRCDIR)/main/tanalyzer.cpp
        program_options

        openssl
        crypto
        png
        z
        dl

        snappy

        krb5
        gssglue
    :
#         <link>static
        $(EXE_DEPENDENCIES)
    ;

exe rdpclient
    : $(SRCDIR)/main/rdp_client.cpp
        program_options
        bitmap
        openssl
        crypto
        png
        z
        dl

        snappy
        krb5
        gssglue
    :
        $(EXE_DEPENDENCIES)
    ;


#
# Functional tests (run by hand)
#

exe tls_test_client
    :
        $(SRCDIR)/ftests/tls_test_client.cpp openssl crypto png dl snappy
    :
#         <link>static
        $(EXE_DEPENDENCIES)
 ;
exe tls_test_server
    :
        $(SRCDIR)/ftests/tls_test_server.cpp openssl crypto png dl snappy
    :
#         <link>static
        $(EXE_DEPENDENCIES)
;

exe make_cpp_config
    : $(SRCDIR)/main/write_cpp_config.cpp
    : <variant>asan:<library>libasan $(GCOV)
;

explicit make_cpp_config ;


#exe freetype_draw : ftests/freetype_draw.cpp freetype
#    : <link>static <variant>coverage:<library>gcov
#;

#add flag -I/usr/include/freetype2

#
# Unit Tests
#

#import testing-coverage ;
import testing ;

import type ;
type.register PYTHON : py ;

actions nop { }

import toolset ;

feature.feature <cov-file> : : free ;
toolset.flags cover COVERFILE : <cov-file> ;

feature.feature <cov-flag> : : free ;
toolset.flags cover COVERFLAG : <cov-flag> ;

actions cover
{
    if [ "++ $(COVERFLAG) ++" = "++ nocover ++" ]; then
        echo "NO COVERAGE"
        touch "$(<)"
    else
        echo "COVERFILE = $(COVERFILE)"
        echo "source = $(>)"
        echo "target = $(<)"
        mkdir -p $(COVERAGE_PREFIX)coverage/$(COVERFILE)
        if [ ! -e $(>:S=.gcno) ]; then
            echo "coverage file $(>:S=.gcno) does not exist"
            exit 1
        fi
        
        echo "gcov --unconditional-branches --all-blocks --branch-count --branch-probabilities --function-summaries --demangled-names -o $(>:S=.gcno) $(>:S=) > $(COVERAGE_PREFIX)coverage/$(COVERFILE)/report.coverage"
        gcov --unconditional-branches --all-blocks --branch-count --branch-probabilities --function-summaries --demangled-names -o $(>:S=.gcno) $(>:S=) > $(COVERAGE_PREFIX)coverage/$(COVERFILE)/report.coverage
        if [ $? = "0" ]; then
        
            mv *.gcov $(COVERAGE_PREFIX)coverage/$(COVERFILE)
            if [ $? = "0" ]; then

                if [ ! -e "$(SRCDIR)/$(COVERFILE)" ]; then
                    echo "coverage file $(SRCDIR)/$(COVERFILE) does not exist"
                    exit 1
                fi

                etags -o $(COVERAGE_PREFIX)coverage/$(COVERFILE)/$(COVERFILE:B)$(COVERFILE:S).TAGS $(SRCDIR)/$(COVERFILE)
                if [ $? = "0" ]; then
                    python tools/coverage.py $(COVERFILE) $(COVERAGE_PREFIX)coverage/$(COVERFILE)/$(COVERFILE:B)$(COVERFILE:S).TAGS $(COVERAGE_PREFIX)coverage/$(COVERFILE)/$(COVERFILE:B)$(COVERFILE:S).gcov $(SRCDIR)
                    touch $(<)
                else
                    echo "etags failed"
                    exit 1
                fi
            else
                echo "gcov mv KO"
                exit 1
            fi
        else
            echo "gcov KO"
            exit 1
        fi
    fi
}

rule test-run ( target : sources + : tested : requirements * )
{
#    ECHO "TEST RUN" ;
    sources = $(TESTDIR)/$(sources) ;
    local base = [ MATCH "test_(.*)$" : $(sources[0]:B) ] ;
    local basepath = "" ;
    local path = $(sources[0]:P) ;
    while $(path) != $(TESTDIR) {
        basepath = $(path:B)/$(basepath) ;
        path = $(path:P) ;
    }

#    ECHO "base = $(base)" ;
#    ECHO "sources = $(sources)" ;
#    ECHO "target = $(target)" ;

    run $(sources) : : : $(requirements) $(TEST_DEPENDENCIES) : $(target) ;
    make $(target:S=.coverage) : $(target) : nop 
        : <variant>coverage:<action>@cover 
          <cov-file>$(tested) $(requirements)
        ;
}

# To compute coverage
# ===================
# bjam coverage test_utf.coverage 

## Acl tests
## @{
test-run test_acl_serializer : acl/test_acl_serializer.cpp : acl/acl_serializer.hpp ;
test-run test_authentifier : acl/test_authentifier.cpp : acl/authentifier.hpp : <library>crypto <library>png ;
test-run test_module_manager : acl/test_module_manager.cpp : acl/module_manager.hpp : <library>crypto <library>png ;
## @}

## Capture tests
## @{
test-run test_CaptureDevice 
    : capture/test_CaptureDevice.cpp 
    : capture/CaptureDevice.hpp 
    ;
test-run test_capture 
    : capture/test_capture.cpp 
    : capture/capture.hpp 
    : <library>bitmap <library>crypto <library>dl <library>png <library>z <library>snappy 
    ;
test-run test_chunked_image_transport 
    : capture/test_chunked_image_transport.cpp 
    : capture/chunked_image_transport.hpp 
    : <library>bitmap <library>png <library>z <library>snappy <library>crypto 
    ;

test-run test_ChunkToFile 
    : capture/test_ChunkToFile.cpp 
    : capture/ChunkToFile.hpp 
    ;

test-run test_FileToChunk 
    : capture/test_FileToChunk.cpp
    : capture/FileToChunk.hpp 
    : <library>png 
    ;

test-run test_FileToGraphic 
    : capture/test_FileToGraphic.cpp 
    : capture/FileToGraphic.hpp 
    : <library>bitmap <library>png <library>snappy <library>crypto 
    ;

test-run test_GraphicToFile 
    : capture/test_GraphicToFile.cpp 
    : capture/GraphicToFile.hpp 
    : <library>bitmap <library>png <library>crypto <library>snappy 
#    : <library>bitmap <library>png <library>z <library>snappy <library>crypto 
    
    ;

test-run test_image_capture 
    : capture/test_image_capture.cpp 
    : capture/image_capture.hpp 
    : <library>bitmap <library>png 
    ;

test-run test_nativecapture 
    : capture/test_nativecapture.cpp 
    : capture/nativecapture.hpp 
    : <library>bitmap <library>png <library>crypto <library>snappy 
    ;

test-run test_new_kbdcapture 
    : capture/test_new_kbdcapture.cpp 
    : capture/new_kbdcapture.hpp 
    ;

test-run test_RDPChunkedDevice 
    : capture/test_RDPChunkedDevice.cpp 
    : capture/RDPChunkedDevice.hpp 
    ;

test-run test_send_wrm_chunk 
    : capture/test_send_wrm_chunk.cpp 
    : capture/send_wrm_chunk.hpp 
    ;

test-run test_staticcapture 
    : capture/test_staticcapture.cpp 
    : capture/staticcapture.hpp 
    : <library>png 
    ;

test-run test_transparentchunk 
    : capture/test_transparentchunk.cpp 
    : capture/transparentchunk.hpp 
    ;

test-run test_transparentplayer 
    : capture/test_transparentplayer.cpp 
    : capture/transparentplayer.hpp 
    ;

test-run test_transparentrecorder 
    : capture/test_transparentrecorder.cpp 
    : capture/transparentrecorder.hpp 
    ;

test-run test_utils_match_finder 
    : capture/utils/test_match_finder.cpp 
    : capture/utils/match_finder.hpp 
    : <cov-flag>nocover
    ;

test-run test_wrm_label 
    : capture/test_wrm_label.cpp 
    : capture/wrm_label.hpp 
    ;

## @}

## Test facility functions or classes
## @{
test-run test_iter 
    : utils/test_iter.cpp 
    : utils/iter.hpp 
    ;

test-run test_noncopyable 
    : utils/test_noncopyable.cpp 
    : utils/noncopyable.hpp 
    ;

test-run test_splitter 
    : utils/test_splitter.cpp 
    : utils/splitter.hpp 
    ;

test-run test_algostring 
    : utils/test_algostring.cpp 
    : utils/algostring.hpp 
    ;

test-run test_make_unique 
    : utils/test_make_unique.cpp 
    : utils/make_unique.hpp 
    : ;
## @}

test-run test_stream 
    : utils/test_stream.cpp 
    : utils/stream.hpp 
    ;

test-run test_utf 
    : utils/test_utf.cpp 
    : utils/utf.hpp 
    ;
test-run test_rect 
    : utils/test_rect.cpp
    : utils/rect.hpp 
    ;
    
test-run test_ellipse 
    : utils/test_ellipse.cpp 
    : utils/ellipse.hpp 
    ;

test-run test_drawable 
    : utils/test_drawable.cpp 
    : utils/drawable.hpp 
    : <library>bitmap <library>png <library>crypto 
    ;

test-run test_region 
    : utils/test_region.cpp 
    : utils/region.hpp 
    ;

test-run test_bitfu 
    : utils/test_bitfu.cpp
    : utils/bitfu.hpp
    ;
    
test-run test_parse 
    : utils/test_parse.cpp 
    : utils/parse.hpp 
    ;
    
test-run test_parser 
    : utils/test_parser.cpp 
    : utils/parser.hpp 
    ;
    
test-run test_fileutils 
    : utils/test_fileutils.cpp 
    : utils/fileutils.hpp 
    ;
    
test-run test_parse_ip_conntrack 
    : utils/test_parse_ip_conntrack.cpp 
    : utils/parse_ip_conntrack.hpp 
    ;
    
test-run test_x224 
    : core/RDP/test_x224.cpp 
    : core/RDP/x224.hpp 
    ;
    
test-run test_out_per_bstream 
    : core/RDP/test_out_per_bstream.cpp 
    : core/RDP/out_per_bstream.hpp 
    ;
    
test-run test_mcs 
    : core/RDP/test_mcs.cpp 
    : core/RDP/mcs.hpp 
    ;

test-run test_mppc 
    : core/RDP/test_mppc.cpp
    : core/RDP/mppc.hpp
    ;
    
test-run test_mppc_40 
    : core/RDP/test_mppc_40.cpp 
    : core/RDP/mppc_40.hpp 
    ;
    
test-run test_mppc_50 
    : core/RDP/test_mppc_50.cpp 
    : core/RDP/mppc_50.hpp 
    ;
    
test-run test_mppc_60 
    : core/RDP/test_mppc_60.cpp
    : core/RDP/mppc_60.hpp
    ;
    
test-run test_mppc_61 
    : core/RDP/test_mppc_61.cpp
    : core/RDP/mppc_61.hpp
    ;
    
test-run test_gcc 
    : core/RDP/test_gcc.cpp 
    : core/RDP/gcc.hpp 
    : <library>dl <library>z <library>crypto 
    ;

test-run test_sec 
    : core/RDP/test_sec.cpp 
    : core/RDP/sec.hpp 
    : <library>crypto 
    ;

test-run test_lic 
    : core/RDP/test_lic.cpp 
    : core/RDP/lic.hpp 
    : <library>crypto 
    ;

test-run test_share 
    : core/RDP/test_share.cpp 
    : core/RDP/share.hpp 
    ;

test-run test_fastpath 
    : core/RDP/test_fastpath.cpp 
    : core/RDP/fastpath.hpp 
    : <library>crypto 
    ;
    
test-run test_slowpath 
    : core/RDP/test_slowpath.cpp 
    : core/RDP/slowpath.hpp 
    ;

test-run test_clipboard 
    : core/RDP/test_clipboard.cpp 
    : core/RDP/clipboard.hpp 
    ;

test-run test_FileInformation 
    : core/FSCC/test_FileInformation.cpp 
    : core/FSCC/FileInformation.hpp 
    ;

test-run test_rdpdr 
    : core/RDP/channels/test_rdpdr.cpp 
    : core/RDP/channels/rdpdr.hpp 
    ;

test-run test_callback 
    : core/test_callback.cpp 
    : core/callback.hpp 
    ;
test-run test_channel_list 
    : core/test_channel_list.cpp 
    : core/channel_list.hpp 
    ;
test-run test_check_files 
    : core/test_check_files.cpp 
    : core/check_files.hpp 
    ;
test-run test_client_info 
    : core/test_client_info.cpp 
    : core/client_info.hpp 
    ;
test-run test_theme 
    : utils/test_theme.cpp 
    : utils/theme.hpp 
    ;
test-run test_confdescriptor 
    : utils/test_confdescriptor.cpp 
    : utils/confdescriptor.hpp 
    ;
test-run test_error 
    : core/test_error.cpp 
    : core/error.hpp 
    ;
test-run test_font 
    : core/test_font.cpp 
    : core/font.hpp 
    ;
    
test-run test_listen 
    : core/test_listen.cpp 
    : core/listen.hpp 
    ;
test-run test_mainloop 
    : core/test_mainloop.cpp 
    : core/mainloop.hpp 
    ;
test-run test_bitmapupdate 
    : core/RDP/test_bitmapupdate.cpp 
    : core/RDP/bitmapupdate.hpp 
    : <library>bitmap <library>png <library>crypto 
    ;
test-run test_bmpcache 
    : core/RDP/caches/test_bmpcache.cpp 
    : core/RDP/caches/bmpcache.hpp 
    : <library>bitmap <library>png <library>crypto 
    ;
test-run test_bmpcachepersister 
    : core/RDP/caches/test_bmpcachepersister.cpp 
    : core/RDP/caches/bmpcachepersister.hpp 
    : <library>bitmap <library>crypto 
    ;
test-run test_brushcache 
    : core/RDP/caches/test_brushcache.cpp 
    : core/RDP/caches/brushcache.hpp 
    ;
test-run test_glyphcache 
    : core/RDP/caches/test_glyphcache.cpp 
    : core/RDP/caches/glyphcache.hpp 
    ;
test-run test_pointercache 
    : core/RDP/caches/test_pointercache.cpp 
    : core/RDP/caches/pointercache.hpp 
    ;
test-run test_redirection_info 
    : utils/test_redirection_info.cpp 
    : utils/redirection_info.hpp 
    ;

## Capabilities tests
## @{
test-run test_bitmapcodecs 
    : core/RDP/capabilities/test_bitmapcodecs.cpp 
    : core/RDP/capabilities/bitmapcodecs.hpp 
    ;

test-run test_activate 
    : core/RDP/capabilities/test_activate.cpp 
    : core/RDP/capabilities/activate.hpp 
    ;
test-run test_cap_bitmap 
    : core/RDP/capabilities/test_cap_bitmap.cpp 
    : core/RDP/capabilities/cap_bitmap.hpp 
    ;

if [ SHELL false ] {

obj test_cap_bmpcache.o 
    : core/RDP/capabilities/test_bmpcache.cpp 
    : core/RDP/capabilities/test_bmpcache.cpp 
    ;

test-run test_cap_bmpcache 
    : test_cap_bmpcache.o 
    : test_cap_bmpcache.o 
    ;
}

#test-run test_cap_bmpcache : core/RDP/capabilities/test_bmpcache.cpp : ;

test-run test_bitmapcachehostsupport 
    : core/RDP/capabilities/test_bitmapcachehostsupport.cpp 
    : core/RDP/capabilities/bitmapcachehostsupport.hpp 
    ;
test-run test_cap_brushcache 
    : core/RDP/capabilities/test_cap_brushcache.cpp 
    : core/RDP/capabilities/cap_brushcache.hpp 
    ;
test-run test_compdesk 
    : core/RDP/capabilities/test_compdesk.cpp 
    : core/RDP/capabilities/compdesk.hpp 
    ;
test-run test_control 
    : core/RDP/capabilities/test_control.cpp 
    : core/RDP/capabilities/control.hpp 
    ;

test-run test_drawgdiplus 
    : core/RDP/capabilities/test_drawgdiplus.cpp 
    : core/RDP/capabilities/drawgdiplus.hpp 
    ;
test-run test_drawninegridcache 
    : core/RDP/capabilities/test_drawninegridcache.cpp 
    : core/RDP/capabilities/drawninegridcache.hpp 
    ;
test-run test_cap_font 
    : core/RDP/capabilities/test_cap_font.cpp 
    : core/RDP/capabilities/cap_font.hpp 
    ;
test-run test_frameacknowledge 
    : core/RDP/capabilities/test_frameacknowledge.cpp 
    : core/RDP/capabilities/frameacknowledge.hpp 
    ;
test-run test_general 
    : core/RDP/capabilities/test_general.cpp 
    : core/RDP/capabilities/general.hpp 
    ;
test-run test_cap_glyphcache 
    : core/RDP/capabilities/test_cap_glyphcache.cpp 
    : core/RDP/capabilities/cap_glyphcache.hpp 
    ;
test-run test_input 
    : core/RDP/capabilities/test_input.cpp 
    : core/RDP/capabilities/input.hpp 
    ;
test-run test_largepointer 
    : core/RDP/capabilities/test_largepointer.cpp 
    : core/RDP/capabilities/largepointer.hpp 
    ;
test-run test_multifragmentupdate 
    : core/RDP/capabilities/test_multifragmentupdate.cpp 
    : core/RDP/capabilities/multifragmentupdate.hpp 
    ;
test-run test_offscreencache 
    : core/RDP/capabilities/test_offscreencache.cpp 
    : core/RDP/capabilities/offscreencache.hpp 
    ;
test-run test_order 
    : core/RDP/capabilities/test_order.cpp 
    : core/RDP/capabilities/order.hpp 
    ;
test-run test_pointer 
    : core/RDP/capabilities/test_pointer.cpp 
    : core/RDP/capabilities/pointer.hpp 
    ;
test-run test_rail 
    : core/RDP/capabilities/test_rail.cpp 
    : core/RDP/capabilities/rail.hpp 
    ;
test-run test_cap_share 
    : core/RDP/capabilities/test_cap_share.cpp 
    : core/RDP/capabilities/cap_share.hpp 
    ;
test-run test_cap_sound 
    : core/RDP/capabilities/test_cap_sound.cpp 
    : core/RDP/capabilities/cap_sound.hpp 
    ;
test-run test_surfacecommands 
    : core/RDP/capabilities/test_surfacecommands.cpp 
    : core/RDP/capabilities/surfacecommands.hpp 
    ;
test-run test_window 
    : core/RDP/capabilities/test_window.cpp 
    : core/RDP/capabilities/window.hpp 
    ;

test-run test_bmpcache2 
    : core/RDP/capabilities/test_bmpcache2.cpp 
    : core/RDP/capabilities/bmpcache2.hpp 
    ;
test-run test_colcache 
    : core/RDP/capabilities/test_colcache.cpp 
    : core/RDP/capabilities/colcache.hpp 
    ;
test-run test_common 
    : core/RDP/capabilities/test_common.cpp 
    : core/RDP/capabilities/common.hpp 
    ;
test-run test_virchan 
    : core/RDP/capabilities/test_virchan.cpp 
    : core/RDP/capabilities/virchan.hpp 
    ;
## @}


test-run test_ServerRedirection 
    : core/RDP/test_ServerRedirection.cpp 
    : core/RDP/ServerRedirection.hpp 
    ;

test-run test_GraphicUpdatePDU 
    : core/RDP/test_GraphicUpdatePDU.cpp 
    : core/RDP/GraphicUpdatePDU.hpp 
    ;

test-run test_RefreshRectPDU 
    : core/RDP/test_RefreshRectPDU.cpp 
    : core/RDP/RefreshRectPDU.hpp 
    : <library>crypto 
    ;
    
test-run test_logon 
    : core/RDP/test_logon.cpp 
    : core/RDP/logon.hpp 
    ;
    
test-run test_nego 
    : core/RDP/test_nego.cpp 
    : core/RDP/nego.hpp 
    : <library>openssl <library>crypto <library>dl <library>krb5 <library>gssglue 
    ;

test-run test_RDPOrdersCommon 
    : core/RDP/orders/test_RDPOrdersCommon.cpp 
    : core/RDP/orders/RDPOrdersCommon.hpp 
    ;

test-run test_RDPOrdersPrimaryMem3Blt 
    : core/RDP/orders/test_RDPOrdersPrimaryMem3Blt.cpp 
    : core/RDP/orders/RDPOrdersPrimaryMem3Blt.hpp 
    ;
    
test-run test_RDPOrdersSecondaryGlyphCache 
    : core/RDP/orders/test_RDPOrdersSecondaryGlyphCache.cpp 
    : core/RDP/orders/RDPOrdersSecondaryGlyphCache.hpp 
    ;
    
test-run test_RDPDrawable 
    : core/RDP/test_RDPDrawable.cpp 
    : core/RDP/RDPDrawable.hpp 
    : <library>crypto <library>png 
    ;
    
test-run test_RDPGraphicDevice 
    : core/RDP/test_RDPGraphicDevice.cpp 
    : core/RDP/RDPGraphicDevice.hpp 
    ;
    
test-run test_RDPSerializer 
    : core/RDP/test_RDPSerializer.cpp 
    : core/RDP/RDPSerializer.hpp 
    ;
    
test-run test_remote_programs 
    : core/RDP/test_remote_programs.cpp 
    : core/RDP/remote_programs.hpp 
    ;
    
test-run test_server 
    : core/test_server.cpp 
    : core/server.hpp 
    ;
    
test-run test_session 
    : core/test_session.cpp 
    : core/session.hpp 
    ;
    
test-run test_session_server 
    : core/test_session_server.cpp 
    : core/session_server.hpp 
    ;
    
test-run test_wait_obj 
    : core/test_wait_obj.cpp
    : core/wait_obj.hpp
    ;
    
test-run test_front 
    : front/test_front.cpp 
    : front/front.hpp 
    : <library>bitmap <library>openssl 
      <library>snappy <library>d3des 
      <library>krb5 <library>gssglue 
      <library>png <library>d3des 
      <library>dl <library>crypto 
    ;
    
test-run test_mod_api 
    : mod/test_mod_api.cpp 
    : mod/mod_api.hpp 
    ;

test-run test_mod_osd 
    : mod/test_mod_osd.cpp 
    : mod/mod_osd.hpp 
    : <library>bitmap <library>png 
    ;

test-run test_null 
    : mod/null/test_null.cpp 
    : mod/null/null.hpp 
    ;
    
test-run test_rdp_orders 
    : mod/rdp/test_rdp_orders.cpp 
    : mod/rdp/rdp_orders.hpp 
    ;
    
test-run test_rdpdr_asynchronous_task 
    : mod/rdp/channels/test_rdpdr_asynchronous_task.cpp 
    : mod/rdp/channels/rdpdr_asynchronous_task.hpp 
    ;
    
test-run test_cliprdr_channel 
    : mod/rdp/channels/test_cliprdr_channel.cpp
    : mod/rdp/channels/cliprdr_channel.hpp
    : <library>png 
    ;

test-run test_rdpdr_channel 
    : mod/rdp/channels/test_rdpdr_channel.cpp 
    : mod/rdp/channels/rdpdr_channel.hpp 
    : <library>png ;
    
test-run test_vnc 
    : mod/vnc/test_vnc.cpp 
    : mod/vnc/vnc.hpp 
    ;
    
test-run test_xup 
    : mod/xup/test_xup.cpp 
    : mod/xup/xup.hpp 
    ;
    
test-run test_bitmap 
    : utils/test_bitmap.cpp 
    : utils/bitmap.hpp 
    : <library>bitmap <library>png <library>crypto 
    ;

if [ SHELL false ] {
test-run test_bitmap_perf 
    : test_bitmap_perf.cpp 
    : bitmap_perf.hpp 
    : <library>bitmap <library>png 
    ;
}

test-run test_colors 
    : utils/test_colors.cpp 
    : utils/colors.hpp 
    ;
    
test-run test_d3des 
    : utils/test_d3des.cpp 
    : utils/d3des.hpp 
    ;
    
test-run test_difftimeval 
    : utils/test_difftimeval.cpp 
    : utils/difftimeval.hpp 
    ;
    
test-run test_genrandom 
    : utils/test_genrandom.cpp 
    : utils/genrandom.hpp 
    ;
test-run test_log 
    : utils/test_log.cpp 
    : utils/log.hpp 
    ;

test-run test_netutils 
    : utils/test_netutils.cpp 
    : utils/netutils.hpp 
    ;

test-run test_png 
    : utils/test_png.cpp 
    : utils/png.hpp 
    : <library>png ;

test-run test_rdtsc 
    : utils/test_rdtsc.cpp 
    : utils/rdtsc.hpp 
    ;

test-run test_ssl_calls 
    : system/linux/system/test_ssl_calls.cpp 
    : system/linux/system/ssl_calls.hpp 
    : <library>openssl <library>crypto <library>dl <library>z ;

if [ SHELL false ] {
test-run test_strings 
    : test_strings.cpp 
    : strings.hpp 
    ;
}

## Transport tests
## @{
test-run test_meta_writer 
    : transport/detail/test_meta_writer.cpp 
    : transport/detail/meta_writer.hpp 
    ;

test-run test_meta_opener 
    : transport/detail/test_meta_opener.cpp 
    : transport/detail/meta_opener.hpp 
    ;

test-run test_in_meta_sequence_transport 
    : transport/test_in_meta_sequence_transport.cpp 
    : transport/in_meta_sequence_transport.hpp 
    : <library>crypto <library>snappy <library>dl <library>z 
    ;

if [ SHELL false ] {
test-run test_filename_sequence_transport 
    : transport/test_filename_sequence_transport.cpp 
    : transport/filename_sequence_transport.hpp 
    ;
}

test-run test_out_meta_sequence_transport 
    : transport/test_out_meta_sequence_transport.cpp 
    : transport/out_meta_sequence_transport.hpp 
    : <library>crypto <library>snappy <library>dl <library>z 
    ;

test-run test_test_transport 
    : transport/test_test_transport.cpp 
    : transport/transport.hpp 
    ;
    
test-run test_count_transport 
    : transport/test_count_transport.cpp 
    : transport/count_transport.hpp 
    ;
    
test-run test_socket_transport 
    : transport/test_socket_transport.cpp 
    : transport/socket_transport.hpp 
    : <library>openssl <library>crypto <library>dl 
    ;

if [ SHELL false ] {
test-run test_file_transport 
    : transport/test_file_transport.cpp 
    : transport/file_transport.hpp 
    ;

test-run test_request_full_cleaning 
    : transport/test_request_full_cleaning.cpp 
    : transport/request_full_cleaning.hpp 
    ;

test-run test_filename_transport 
    : transport/test_filename_transport.cpp 
    : transport/filename_transport.hpp 
    : <library>z <library>dl <library>snappy <library>crypto 
    ;
}

test-run test_bulk_compression_transport 
    : transport/test_bulk_compression_transport.cpp 
    : transport/bulk_compression_transport.hpp 
    ;

test-run test_gzip_compression_transport 
    : transport/test_gzip_compression_transport.cpp 
    : transport/gzip_compression_transport.hpp 
    : <library>z 
    ;

test-run test_snappy_compression_transport 
    : transport/test_snappy_compression_transport.cpp 
    : transport/snappy_compression_transport.hpp 
    : <library>snappy 
    ;

test-run test_cryptofile 
    : transport/test_cryptofile.cpp 
    : transport/cryptofile.hpp 
    : <library>openssl <library>crypto <library>snappy <library>dl <library>z 
    ;

test-run test_compression_transport_wrapper 
    : utils/test_compression_transport_wrapper.cpp 
    : utils/compression_transport_wrapper.hpp 
    : <library>z <library>snappy 
    ;
## @}


## Buffer Transport tests
## @{
test-run test_buffering_buf 
    : transport/buffer/test_buffering_buf.cpp 
    : transport/buffer/buffering_buf.hpp 
    ;

test-run test_checksum_buf 
    : transport/buffer/test_checksum_buf.cpp 
    : transport/buffer/checksum_buf.hpp 
    : <library>crypto <library>dl <library>z 
    ;
## @}



#test-run test_crypt_openssl : test_crypt_openssl.cpp : <library>z <library>dl <library>crypto <library>png <library>libboost_unit_test ;
#test-run test_capture_wrm : capture/test_capture_wrm.cpp : <library>png <library>z <library>crypto <library>libboost_unit_test ;

test-run test_RDPOrdersPrimaryOpaqueRect 
    : core/RDP/orders/test_RDPOrdersPrimaryOpaqueRect.cpp 
    : core/RDP/orders/RDPOrdersPrimaryOpaqueRect.hpp 
    ;
    
test-run test_RDPOrdersPrimaryScrBlt 
    : core/RDP/orders/test_RDPOrdersPrimaryScrBlt.cpp 
    : core/RDP/orders/RDPOrdersPrimaryScrBlt.hpp 
    ;
    
test-run test_RDPOrdersPrimaryMemBlt 
    : core/RDP/orders/test_RDPOrdersPrimaryMemBlt.cpp 
    : core/RDP/orders/RDPOrdersPrimaryMemBlt.hpp 
    ;
    
test-run test_RDPOrdersPrimaryDestBlt 
    : core/RDP/orders/test_RDPOrdersPrimaryDestBlt.cpp 
    : core/RDP/orders/RDPOrdersPrimaryDestBlt.hpp 
    ;
    
test-run test_RDPOrdersPrimaryMultiDstBlt 
    : core/RDP/orders/test_RDPOrdersPrimaryMultiDstBlt.cpp 
    : core/RDP/orders/RDPOrdersPrimaryMultiDstBlt.hpp 
    ;
    
test-run test_RDPOrdersPrimaryMultiPatBlt 
    : core/RDP/orders/test_RDPOrdersPrimaryMultiPatBlt.cpp 
    : core/RDP/orders/RDPOrdersPrimaryMultiPatBlt.hpp 
    ;
    
test-run test_RDPOrdersPrimaryMultiScrBlt 
    : core/RDP/orders/test_RDPOrdersPrimaryMultiScrBlt.cpp 
    : core/RDP/orders/RDPOrdersPrimaryMultiScrBlt.hpp 
    ;
    
test-run test_RDPOrdersPrimaryMultiOpaqueRect 
    : core/RDP/orders/test_RDPOrdersPrimaryMultiOpaqueRect.cpp 
    : core/RDP/orders/RDPOrdersPrimaryMultiOpaqueRect.hpp 
    ;
    
test-run test_RDPOrdersPrimaryLineTo 
    : core/RDP/orders/test_RDPOrdersPrimaryLineTo.cpp 
    : core/RDP/orders/RDPOrdersPrimaryLineTo.hpp 
    ;
    
test-run test_RDPOrdersPrimaryPolygonSC 
    : core/RDP/orders/test_RDPOrdersPrimaryPolygonSC.cpp 
    : core/RDP/orders/RDPOrdersPrimaryPolygonSC.hpp 
    ;
    
test-run test_RDPOrdersPrimaryPolygonCB 
    : core/RDP/orders/test_RDPOrdersPrimaryPolygonCB.cpp 
    : core/RDP/orders/RDPOrdersPrimaryPolygonCB.hpp 
    ;
test-run test_RDPOrdersPrimaryPolyline 
    : core/RDP/orders/test_RDPOrdersPrimaryPolyline.cpp 
    : core/RDP/orders/RDPOrdersPrimaryPolyline.hpp 
    ;
test-run test_RDPOrdersPrimaryEllipseSC 
    : core/RDP/orders/test_RDPOrdersPrimaryEllipseSC.cpp 
    : core/RDP/orders/RDPOrdersPrimaryEllipseSC.hpp 
    ;
    
test-run test_RDPOrdersPrimaryEllipseCB
    : core/RDP/orders/test_RDPOrdersPrimaryEllipseCB.cpp 
    : core/RDP/orders/RDPOrdersPrimaryEllipseCB.hpp 
    ;
    
test-run test_RDPOrdersPrimaryPatBlt 
    : core/RDP/orders/test_RDPOrdersPrimaryPatBlt.cpp 
    : core/RDP/orders/RDPOrdersPrimaryPatBlt.hpp
    ;
    
test-run test_RDPOrdersPrimaryGlyphIndex 
    : core/RDP/orders/test_RDPOrdersPrimaryGlyphIndex.cpp 
    : core/RDP/orders/RDPOrdersPrimaryGlyphIndex.hpp 
    ;
    
test-run test_RDPOrdersSecondaryBmpCache 
    : core/RDP/orders/test_RDPOrdersSecondaryBmpCache.cpp 
    : core/RDP/orders/RDPOrdersSecondaryBmpCache.hpp 
    : <library>bitmap <library>crypto 
    ;
    
test-run test_RDPOrdersSecondaryColorCache 
    : core/RDP/orders/test_RDPOrdersSecondaryColorCache.cpp 
    : core/RDP/orders/RDPOrdersSecondaryColorCache.hpp 
    ;
    
test-run test_RDPOrdersSecondaryBrushCache 
    : core/RDP/orders/test_RDPOrdersSecondaryBrushCache.cpp 
    : core/RDP/orders/RDPOrdersSecondaryBrushCache.hpp 
    ;
    
test-run test_AlternateSecondaryWindowing 
    : core/RDP/orders/test_AlternateSecondaryWindowing.cpp 
    : core/RDP/orders/AlternateSecondaryWindowing.hpp 
    ;

if [ SHELL false ] {

test-run test_libpng 
    : test_libpng.cpp 
    : libpng.hpp 
    : <library>png <library>z 
    ;
}

#test-run test_convert_bitmap : test_convert_bitmap.cpp : <library>png <library>z <library>crypto <library>dl <library>libboost_unit_test ;
test-run test_rdp 
    : mod/rdp/test_rdp.cpp 
    : mod/rdp/rdp.hpp 
    : <library>bitmap <library>krb5 
      <library>gssglue <library>png 
      <library>d3des <library>z 
      <library>dl <library>crypto 
    ;

if [ SHELL false ] {
    
test-run test_rdp_client_test_card 
    : client_mods/test_rdp_client_test_card.cpp 
    : client_mods/rdp_client_test_card.hpp 
    : <library>bitmap <library>z 
      <library>png <library>crypto 
      <library>dl <library>openssl 
    ;
test-run test_rdp_client_tls_w2008 
    : client_mods/test_rdp_client_tls_w2008.cpp 
    : client_mods/rdp_client_tls_w2008.hpp 
    : <library>bitmap <library>krb5 
      <library>gssglue <library>png 
      <library>crypto <library>d3des 
      <library>z <library>dl 
      <library>openssl 
    ;

test-run test_rdp_client_wab 
    : client_mods/test_rdp_client_wab.cpp 
    : client_mods/rdp_client_wab.hpp 
    : <library>bitmap <library>krb5 
      <library>gssglue <library>png 
      <library>crypto <library>d3des 
      <library>openssl <library>dl 
      <library>krb5 <library>gssglue 
    ;

test-run test_vnc_client_simple 
    : client_mods/test_vnc_client_simple.cpp 
    : client_mods/vnc_client_simple.hpp 
    : <library>bitmap <library>krb5 
      <library>gssglue <library>png 
      <library>crypto <library>d3des 
      <library>dl 
    ;

test-run test_rdesktop_client 
    : server/test_rdesktop_client.cpp 
    : server/rdesktop_client.hpp 
    : <library>bitmap <library>png 
      <library>openssl <library>snappy 
      <library>d3des <library>crypto 
      <library>dl 
    ;

test-run test_mstsc_client 
    : server/test_mstsc_client.cpp 
    : server/mstsc_client.hpp 
    : <library>bitmap <library>png 
      <library>openssl <library>snappy 
      <library>d3des <library>crypto 
      <library>dl 
    ;

test-run test_mstsc_client_rdp50bulk 
    : server/test_mstsc_client_rdp50bulk.cpp 
    : server/mstsc_client_rdp50bulk.hpp 
    : <library>bitmap <library>png 
      <library>openssl <library>snappy 
      <library>d3des <library>crypto 
      <library>dl 
    ;

test-run test_keymap2 
    : test_keymap2.cpp 
    : keymap2.hpp 
    ;
    
test-run test_keymapSym 
    : test_keymapSym.cpp 
    : keymapSym.hpp 
    ;
}

if [ SHELL false ] {

## Widget tests
## @{
test-run test_widget2_rect : mod/internal/widget2/test_widget2_rect.cpp : <library>png <library>crypto ;
test-run test_image : mod/internal/widget2/test_image.cpp : <library>bitmap <library>png <library>crypto ;
test-run test_label : mod/internal/widget2/test_label.cpp : <library>png <library>crypto ;
test-run test_tooltip : mod/internal/widget2/test_tooltip.cpp : <library>png <library>crypto ;
test-run test_flat_button : mod/internal/widget2/test_flat_button.cpp : <library>png <library>crypto ;
test-run test_edit : mod/internal/widget2/test_edit.cpp : <library>png <library>crypto ;
test-run test_multiline : mod/internal/widget2/test_multiline.cpp : <library>png <library>crypto ;
test-run test_password : mod/internal/widget2/test_password.cpp : <library>png <library>crypto ;
test-run test_number_edit : mod/internal/widget2/test_number_edit.cpp : <library>png <library>crypto ;
test-run test_edit_valid : mod/internal/widget2/test_edit_valid.cpp : <library>png <library>crypto ;
# test-run test_radio_list : mod/internal/widget2/test_radio_list.cpp : <library>png <library>libboost_unit_test ;
test-run test_flat_dialog : mod/internal/widget2/test_flat_dialog.cpp : <library>bitmap <library>png <library>crypto ;
test-run test_widget : mod/internal/widget2/test_widget.cpp : <library>crypto ;
test-run test_composite : mod/internal/widget2/test_composite.cpp : <library>png <library>crypto ;

#test-run test_window_dialog : mod/internal/widget2/test_window_dialog.cpp : <library>png <library>z <library>crypto <library>dl ;

test-run test_flat_login : mod/internal/widget2/test_flat_login.cpp : <library>bitmap <library>png <library>crypto ;
test-run test_flat_wab_close : mod/internal/widget2/test_flat_wab_close.cpp : <library>bitmap <library>png <library>crypto ;
test-run test_screen : mod/internal/widget2/test_screen.cpp : <library>png <library>crypto ;

# test-run test_columnlayout : mod/internal/widget2/test_columnlayout.cpp : <library>png ;
# test-run test_linelayout : mod/internal/widget2/test_linelayout.cpp : <library>png ;
# test-run test_stacklayout : mod/internal/widget2/test_stacklayout.cpp : <library>png ;
test-run test_grid : mod/internal/widget2/test_grid.cpp : <library>png <library>crypto ;
test-run test_labelgrid : mod/internal/widget2/test_labelgrid.cpp : <library>png <library>crypto ;

test-run test_flat_selector2 : mod/internal/widget2/test_flat_selector2.cpp : <library>png <library>crypto ;
test-run test_group_box : mod/internal/widget2/test_group_box.cpp : <library>png <library>crypto ;
# test-run test_scroll : mod/internal/widget2/test_scroll.cpp : <library>png ;
# test-run test_tab : mod/internal/widget2/test_tab.cpp : <library>png ;
test-run test_flat_interactive_target : mod/internal/widget2/test_flat_interactive_target.cpp : <library>png <library>crypto ;
## @}


## Mod tests
## @{
test-run test_flat_dialog_mod : mod/internal/test_flat_dialog_mod.cpp : <library>bitmap <library>png ;
test-run test_flat_login_mod : mod/internal/test_flat_login_mod.cpp : <library>bitmap <library>png ;
test-run test_flat_wab_close_mod : mod/internal/test_flat_wab_close_mod.cpp : <library>bitmap <library>png ;
test-run test_widget_test_mod : mod/internal/test_widget_test_mod.cpp : <library>png ;
test-run test_interactive_target_mod : mod/internal/test_interactive_target_mod.cpp : <library>png <library>crypto ;

test-run test_bouncer2_mod : mod/internal/test_bouncer2_mod.cpp : <library>png ;
test-run test_test_card_mod : mod/internal/test_test_card_mod.cpp : ;

test-run test_replay_mod : mod/internal/test_replay_mod.cpp : ;
test-run test_internal_mod : mod/internal/test_internal_mod.cpp : ;

test-run test_copy_paste : mod/internal/test_copy_paste.cpp : <library>png <library>crypto ;
## @}


## Regex tests
## @{
test-run test_regex_state : regex/test_regex_state.cpp : ;
test-run test_regex_parser : regex/test_regex_parser.cpp : ;
test-run test_regex_ndfa : regex/test_regex_ndfa.cpp : ;
test-run test_regex : regex/test_regex.cpp : ;
# test-run benchmark_regex_parser : benchmark/parser.cpp ;
# test-run benchmark_regex_search : benchmark/search.cpp ;
## @}

# test-run test_base64 : utils/test_base64.cpp : ;

test-run test_translation : utils/test_translation.cpp : ;


## NLA TESTS
## @{
test-run test_ber : core/RDP/nla/asn1/test_ber.cpp : ;
test-run test_credssp : core/RDP/nla/test_credssp.cpp : <library>crypto ;
test-run test_sspi : core/RDP/nla/test_sspi.cpp : ;
test-run test_nla : core/RDP/nla/test_nla.cpp : <library>dl <library>krb5 <library>gssglue <library>z <library>crypto ;

alias test_ntlm_suite : test_ntlm_message_negotiate test_ntlm_avpair test_ntlm_message_challenge test_ntlm_message_authenticate test_ntlm_context ;

test-run test_ntlm_message_negotiate : core/RDP/nla/ntlm/test_ntlm_message_negotiate.cpp : <library>crypto ;
test-run test_ntlm_avpair : core/RDP/nla/ntlm/test_ntlm_avpair.cpp : ;
test-run test_ntlm_message_challenge : core/RDP/nla/ntlm/test_ntlm_message_challenge.cpp : <library>crypto ;
test-run test_ntlm_message_authenticate : core/RDP/nla/ntlm/test_ntlm_message_authenticate.cpp : <library>crypto ;
test-run test_ntlm_context : core/RDP/nla/ntlm/test_ntlm_context.cpp : <library>dl <library>z <library>crypto ;
test-run test_ntlm : core/RDP/nla/ntlm/test_ntlm.cpp : <library>dl <library>z <library>crypto ;
test-run test_credentials : core/RDP/nla/kerberos/test_credentials.cpp : <library>krb5 ;
test-run test_kerberos : core/RDP/nla/kerberos/test_kerberos.cpp : <library>krb5 <library>gssglue ;
## @}


test-run test_darray : utils/test_darray.cpp : ;

## Widget for workflow
## @{
test-run test_flat_wait : mod/internal/widget2/test_flat_wait.cpp : <library>png <library>crypto ;
test-run test_flat_form : mod/internal/widget2/test_flat_form.cpp : <library>png <library>crypto ;
## @}

test-run test_authorization_channels : utils/test_authorization_channels.cpp : ;
test-run test_pattutils : utils/test_pattutils.cpp : ;
test-run test_strutils : utils/test_strutils.cpp : ;

test-run test_diffiehellman : utils/test_diffiehellman.cpp : ;

test-run test_finally : utils/test_finally.cpp : ;

test-run test_verifier : test_verifier.cpp : <library>program_options <library>openssl <library>crypto <library>snappy <library>dl <library>z ;


install install-share
    : [ glob sys/share/rdpproxy/[^.k]* ]
    :
    : <location>$(INSTALLDIR)/usr/local/share/rdpproxy
    ;

actions run-python-test {
    rm -f $(<)
    python $(>[1]) && touch $(<)
}

make test_trace.py.unittest
    :
        tools/redcryptofile/test_trace.py
        redcryptofile.so
    :
        run-python-test
    :
    ;
}
