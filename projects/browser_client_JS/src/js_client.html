<!doctype html>
<html>
<head>
  <meta charset="utf-8">
</head>
<body>

<canvas id="canvas" width="800" height="600"></canvas>
<button id="newco" style="vertical-align:top">New Connection</button>
<script>
const canvas = document.getElementById('canvas').getContext('2d');
const newcobutton = document.getElementById('newco');
let socketbutton;
newcobutton.onclick = () => {
    socketbutton.close();
    Module.onRuntimeInitialized();
};

function imageFromBitmap24(idata, w, h, line_size)
{
  const u8data = HEAPU8.subarray(idata, idata + line_size * 3 * h - 1)
  const len = w*h*4
  const arr = new Uint8ClampedArray(len)
  const step = line_size + w*3
  let si = line_size * (h-1)
  let di = 0

  while (di < len) {
    for (let endi = di+w*4; di < endi; si+=3) {
      arr[di++] = u8data[si+2]
      arr[di++] = u8data[si+1]
      arr[di++] = u8data[si]
      arr[di++] = 255
    }
    si -= step
  }

  return new ImageData(arr, w, h)
}

(function(context) {
    const wrappersCb = {
        drawBmp: function(cb) {
            return function(idata, w, h, line_size, dx, dy, dw, dh) {
                const imageData = imageFromBitmap24(idata, w, h, line_size);
                cb(imageData, dx, dy, 0, 0, dw, dh);
            }
        }
    }

    context.RdpClientEventTable = {};

    context.createRdpClient = function(verbosity) {
        const rdpclient = new Module.RdpClient(verbosity);
        const events = {}
        context.RdpClientEventTable[rdpclient.thisptr()] = events
        rdpclient.on = function(eventName, cb) {
            const wrapCb = wrappersCb[eventName];
            if (!wrapCb) {
                console.log('RdpClient: Unknown event ' + eventName)
                return false
            }
            events[eventName] = wrapCb(cb);
            return this
        };
        return rdpclient;
    }
})(window)

var Module = {
  TOTAL_MEMORY: 268435456, // 16**7
  onRuntimeInitialized: function() {
    const rdpclient = createRdpClient(0/*xff*/)
    rdpclient.on('drawBmp', canvas.putImageData.bind(canvas))

    const send_data = function() {
        const out = rdpclient.get_data()
        if (out.length) {
            // console.log("send " + out.length + " bytes")
            socket.send(out)
            rdpclient.clear_data()
        }
        else {
            console.log("client.data is empty")
        }
    }

    canvas.fillStyle = 0xffff00
    canvas.fillRect(0,0,800,600)

    const socket = new WebSocket("ws://localhost:8080", "rdp-protocol")
    socketbutton = socket

    socket.binaryType = 'arraybuffer';

    socket.onopen = function(event) {
        console.log("socket is open")
        const timeout = rdpclient.next_timeout()
        console.log("timeout:", timeout)
        rdpclient.update()
        send_data()
    }

    // Display messages received from the server
    socket.onmessage = function(event) {
        // const bytearray = new Uint8Array(event.data)
        // let text = ""
        // // console.log('Received Binary Message of ' + bytearray.length + ' bytes')
        // for (let byte of bytearray) {
        //     text += ":" + (byte+0x10000).toString(16).substr(-2)
        // }
        // console.log("Server Says: " + text)
        rdpclient.update()
        try {
            rdpclient.next_message(event.data)
        }
        catch (e) {
            stackTrace()
            throw e
        }
        send_data()
    }

    // Display any errors that occur
    socket.onerror = function(event) {
        console.log("Error: " + event.type)
    }

    socket.onclose = function(event) {
        console.log("close: " + event.code + ": " + event.reason)
        rdpclient.delete()
    }
  }
};
</script>
<script src="jsclient.js"></script>

</body>
</html>
