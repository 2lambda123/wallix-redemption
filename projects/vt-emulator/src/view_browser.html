<DOCTYPE html>
<html>
<head>
    <title>Terminal</title>
    <meta charset="UTF-8"/>

<style>
#tty-player {
    font-family: monospace, monospace;
    border: 2px solid #285577;
    border-top: 1px solid #4c7899;
    display: inline-block;
    position: relative;

    background-color: #333;
    color: #eee;
}

#tty-player-title {
    background: #285577;
    border-bottom: 1px solid #4c7899;
    color: #fff;
    margin:0;
    font-family: sans-serif;
    font-weight: bold;
    padding: 0.2em;
    line-height: 1;
    height: 1em;
    cursor: default;
}

#tty-player-terminal {
    margin:0;
    cursor: text;
    line-height: initial;
}
</style>
</head>
<body>

<pre id="tty-player">
<!-- <p id="tty-player-title">No Title</p> -->
<!-- <p id="tty-player-terminal">contents</p> -->
</pre>

<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript">

// python -m SimpleHTTPServer 4104
// script -f >(~/projects/build/redemption-public@projects@vt-emulator/configs/clang-linux-3.8.0/san/terminal_browser screen.json)
// firefox http://localhost:4104/view_browser.html

let ajax_param = {
    url: 'screen.json',
    context: document.getElementById("tty-player"),
    dataType: 'json'
};

(function loop() {
    $.ajax(ajax_param)
    .done(function(screen){
        console.log(screen)
        this.innerHTML = render(screen);
        window.setTimeout(loop, 2000);
    })
    .fail(function(jqxhr, status, e){
        console.log(e)
        window.setTimeout(loop, 2000)
    })
})()


function render(screen)
{
    let rendering_tag = {b: 'b', i: 'i', u: 'u'}

    let elem2html = function(e) {
        let start = ''
        let stop = ''
        if (e.f || e.b) {
            start += '<span style="'
            if (e.b) start += 'background-color:#'+e.b.toString(16)+';'
            if (e.f) start += 'color:#'+e.f.toString(16)
            start += '">'
            stop = '</span>' + stop;
        }
        if (e.r) {
            for (let r of e.r) {
                let tag = rendering_tag[r]
                if (tag) {
                    start += '<'+tag+'>'
                    stop = '</'+tag+'>' + stop;
                }
            }
        }
        return start + (e.s||'') + stop;
    }

    return "<p id='tty-player-title'>" +
        (screen.title||'No Title') +
        "</p><p id='tty-player-terminal'>" +
        screen.data.map(
            (lines) => lines.map(
                (line) => line.map(elem2html).join('')
            ).join('')
        ).join("\n") +
        "</p>"
    ;
}

// pre.innerHTML = render(json)

</script>

</body>
</html>
