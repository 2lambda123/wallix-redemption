import testing ;

import type ;
type.register PYTHON : py ;

import toolset ;
import feature : feature ;

feature.feature <covfile> : : free ;
toolset.flags cover COVERFILE : <covfile> ;

feature.feature <covflag> : : free ;
toolset.flags cover COVERFLAG : <covflag> ;

actions cover
{
    echo "Computing coverage for $(COVERFILE) "

    raise () { echo "$1" ; exit 1 ; }

    # echo "COVERFILE = $(COVERFILE)"
    # echo "source = $(>)"
    # echo "target = $(<)"
    COVER_GCNO=$(>:P)"/$(<:B).gcno"
    [ -e $COVER_GCNO ] || raise "coverage file \"$COVER_GCNO\" does not exist"

    COVER_PATH="$(<).dir"
    TAGS="$COVER_PATH/TAGS"
    mkdir -p "$COVER_PATH"

    #echo "gcov --unconditional-branches --all-blocks --branch-count --branch-probabilities --function-summaries --demangled-names -o "$COVER_GCNO" $(>:S=) > "$COVER_PATH"/report.coverage"
    gcov --unconditional-branches --all-blocks --branch-count --branch-probabilities --function-summaries --demangled-names -o "$COVER_GCNO" "$(>:S=)" > "$COVER_PATH"/report.coverage || raise 'gcov failed'

    mv *.gcov "$COVER_PATH" || raise 'gcov mv failed'

    etags -o "$TAGS" $(COVERFILE) || raise 'etags failed'

    echo $(COVERFILE) | tr ' ' '\n' | while read f ; do
        GCOV="$COVER_PATH/${f##*/}".gcov
        # If no gcov file available for coverage target create an empty one
        [ -e "$GCOV" ] ||:> "$GCOV"
        python tools/coverage.py $f "$TAGS" "$GCOV" ./ || raise 'python tools/coverage.py failed'
    done | tee "$COVER_PATH".report

    : > $(<)
}

actions id {
    : > $(<);
}

lib libunit_test :
    $(SYSTEM_SRC_PATH)/system/test_framework.cpp
:
    <link>shared
    <cxxflags>-frtti
;

constant TEST_DEPENDENCIES :
    <library>libunit_test
    <library>log_test.o
    <include>$(REDEMPTION_TEST_PATH)/includes
    <cxxflags>-frtti
    <define>BOOST_AUTO_TEST_MAIN
    <define>BOOST_TEST_DYN_LINK
    <define>REDEMPTION_DECL_LOG_TEST
    <define>FIXTURES_PATH='\"$(FIXTURES_PATH)\"'
;

rule test-run ( target : source : requirements * : )
{
    unit-test $(target) : $(source) : $(TEST_DEPENDENCIES) $(requirements) ;

    if ! <covflag>nocover in $(requirements)
    {
        local ps = [ property-set.create $(requirements) ] ;
        local files = [ $(ps).get <covfile> ] ;
        if $(files)
        {
            make $(target:S=.coverage) : $(target) : id :
                <variant>coverage:<action>@cover
                <covfile>$(files)
            ;
        }
    }
}
